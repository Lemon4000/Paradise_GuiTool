name: Build and Release

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write  # needed to create releases

jobs:
  build:
    runs-on: windows-latest
    env:
      BUILD_NUM: ${{ github.run_number }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyinstaller pyside6 pillow pyserial openpyxl

      - name: Build EXE (one-file)
        shell: pwsh
        run: |
          python -m PyInstaller -F --noconsole --icon "ICON.png" -n UsartGUI gui/main.py --add-data "config;config" --add-data "gui/resources;gui/resources" --hidden-import serial.tools.list_ports_windows --hidden-import serial.tools.list_ports --runtime-tmpdir . --clean

      - name: Package zip
        shell: pwsh
        run: |
          # Get version from version.py
          $versionContent = Get-Content "version.py" -Raw
          if ($versionContent -match '__version__\s*=\s*"([^"]+)"') {
            $version = $matches[1]
          } else {
            $version = "1.0.0"
          }
          
          # Get commit message (first line)
          $commitMsg = "${{ github.event.head_commit.message }}" -split "`n" | Select-Object -First 1
          $commitMsg = $commitMsg -replace '[<>:"/\\|?*]', '_'  # Remove invalid filename chars
          $commitMsg = $commitMsg.Substring(0, [Math]::Min(50, $commitMsg.Length))  # Limit length
          
          $zipName = "Paradise_GuiToolV${version}-${commitMsg}.zip"
          $zipPath = "dist/$zipName"
          
          # Package exe and config
          Compress-Archive -Path "dist/UsartGUI.exe","config" -DestinationPath $zipPath -Force
          Write-Host "Packaged -> $zipPath"
          
          # Save for next step
          echo "ZIP_NAME=$zipName" >> $env:GITHUB_ENV
          echo "VERSION=$version" >> $env:GITHUB_ENV

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}-build${{ env.BUILD_NUM }}
          name: "Paradise GuiTool V${{ env.VERSION }} - ${{ github.event.head_commit.message }}"
          draft: false
          prerelease: false
          body: |
            ## Paradise GuiTool V${{ env.VERSION }}
            
            ### ? 功能特性
            - ? 电调参数读写配置
            - ? 固件烧录（HEX文件）
            - ? 波特率管理（支持自定义波特率）
            - ? 配置记忆（自动保存上次使用的波特率和文件路径）
            - ? 串口自动检测
            - ? 实时通信日志
            
            ### ? 本次更新
            ${{ github.event.head_commit.message }}
            
            ### ? 构建信息
            - 构建号: #${{ env.BUILD_NUM }}
            - 提交: ${{ github.sha }}
            - 构建时间: ${{ github.event.head_commit.timestamp }}
            
            ### ? 下载说明
            下载 `${{ env.ZIP_NAME }}` 并解压即可使用。
          files: |
            dist/${{ env.ZIP_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Send Email Notification
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "新版本已发布: Paradise GuiTool V${{ env.VERSION }}"
          to: ${{ secrets.EMAIL_TO }}
          from: ${{ secrets.SMTP_USERNAME }}
          body: |
            您好！

            Paradise GuiTool 新版本已自动构建完成：

            ? 版本: V${{ env.VERSION }}
            ? 构建号: #${{ env.BUILD_NUM }}
            ? 下载地址: https://github.com/${{ github.repository }}/releases/tag/v${{ env.VERSION }}-build${{ env.BUILD_NUM }}
            ? 构建时间: ${{ github.event.head_commit.timestamp }}
            ? 提交信息: ${{ github.event.head_commit.message }}

            ? 主要功能：
            - 电调参数读写配置
            - 固件烧录（HEX文件）
            - 波特率管理（支持自定义）
            - 配置记忆功能
            - 串口自动检测

            请访问上述链接下载最新版本。

            此邮件由 GitHub Actions 自动发送。
